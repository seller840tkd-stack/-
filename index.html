import React, { useState, useEffect, useRef } from 'react';
import { Trash2, Plus, Play, Edit3, Save, X, CheckCircle, MousePointer2, ArrowLeft, RotateCcw, Upload, Image as ImageIcon, AlertCircle, Lock, Unlock, Trophy, Menu, Search, Sparkles, Star, Lightbulb, Pencil, Bell, Calendar, Video } from 'lucide-react';

// --- スタイル定義 (Google Fonts読み込み) ---
const FontsStyle = () => (
  <style>{`
    @import url('https://fonts.googleapis.com/css2?family=Yomogi&family=Zen+Maru+Gothic:wght@500;700;900&display=swap');
    
    body {
      font-family: 'Zen Maru Gothic', sans-serif;
    }
    
    .font-hand {
      font-family: 'Yomogi', cursive;
    }

    .bg-grid-pattern {
      background-image: linear-gradient(#e5e7eb 1px, transparent 1px),
                        linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
      background-size: 20px 20px;
    }

    .pop-shadow {
      box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.1);
    }
    
    .pop-shadow-hover:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0px 0px rgba(0,0,0,0.15);
    }

    .pop-shadow-active:active {
      transform: translate(2px, 2px);
      box-shadow: 0px 0px 0px 0px rgba(0,0,0,0.1);
    }
    
    .text-shadow-pop {
      text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
    }
  `}</style>
);

// --- 効果音 (AudioContext) ---
const playSound = (type) => {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;
    
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    
    osc.connect(gain);
    gain.connect(ctx.destination);
    
    const now = ctx.currentTime;

    if (type === 'correct') {
      osc.type = 'sine';
      osc.frequency.setValueAtTime(880, now); 
      osc.frequency.exponentialRampToValueAtTime(1760, now + 0.1); 
      gain.gain.setValueAtTime(0.3, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
      osc.start(now);
      osc.stop(now + 0.4);
    } else if (type === 'wrong') {
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(150, now);
      osc.frequency.linearRampToValueAtTime(80, now + 0.3);
      gain.gain.setValueAtTime(0.3, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
      osc.start(now);
      osc.stop(now + 0.3);
    } else if (type === 'click') {
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(600, now);
      gain.gain.setValueAtTime(0.05, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
      osc.start(now);
      osc.stop(now + 0.1);
    } else if (type === 'clear') {
      osc.type = 'square';
      osc.frequency.setValueAtTime(523.25, now); 
      osc.frequency.setValueAtTime(659.25, now + 0.1); 
      osc.frequency.setValueAtTime(783.99, now + 0.2); 
      osc.frequency.setValueAtTime(1046.50, now + 0.3); 
      gain.gain.setValueAtTime(0.2, now);
      gain.gain.linearRampToValueAtTime(0, now + 1.5);
      osc.start(now);
      osc.stop(now + 1.5);
    }
  } catch (e) {
    console.error("Audio play failed", e);
  }
};

// --- 画像処理 ---
const resizeImage = (file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        const MAX_SIZE = 1024;
        
        if (width > height) {
          if (width > MAX_SIZE) {
            height *= MAX_SIZE / width;
            width = MAX_SIZE;
          }
        } else {
          if (height > MAX_SIZE) {
            width *= MAX_SIZE / height;
            height = MAX_SIZE;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL('image/jpeg', 0.8));
      };
      img.onerror = () => reject(new Error("画像の読み込みに失敗しました"));
      img.src = e.target.result;
    };
    reader.onerror = () => reject(new Error("ファイルの読み込みに失敗しました"));
    reader.readAsDataURL(file);
  });
};

// --- 初期データ ---
const INITIAL_LEVELS = [
  {
    id: 'demo-1',
    title: 'いつもの実験室',
    imgOriginal: 'https://images.unsplash.com/photo-1532094349884-543bc11b234d?q=80&w=800&auto=format&fit=crop',
    imgDiff: 'https://images.unsplash.com/photo-1532094349884-543bc11b234d?q=80&w=800&auto=format&fit=crop&sepia=true', 
    differences: [
      { id: 'd1', x: 20, y: 30, radius: 5 },
      { id: 'd2', x: 60, y: 60, radius: 8 },
      { id: 'd3', x: 80, y: 20, radius: 6 },
    ]
  }
];

const INITIAL_NEWS = [
  {
    id: 'n1',
    date: '2025.11.20',
    title: 'サイトを公開しました！',
    content: '脳トレまちがいさがしへようこそ。毎日遊んで脳を活性化させましょう！',
    image: null
  }
];

const App = () => {
  // Game Levels State
  const [levels, setLevels] = useState(() => {
    try {
      const saved = localStorage.getItem('spotTheDiffLevels');
      return saved ? JSON.parse(saved) : INITIAL_LEVELS;
    } catch (e) {
      return INITIAL_LEVELS;
    }
  });

  // News State
  const [news, setNews] = useState(() => {
    try {
      const saved = localStorage.getItem('spotTheDiffNews');
      return saved ? JSON.parse(saved) : INITIAL_NEWS;
    } catch (e) {
      return INITIAL_NEWS;
    }
  });

  const [view, setView] = useState('home'); // home, play, create, edit, news
  const [currentLevelId, setCurrentLevelId] = useState(null);
  const [storageError, setStorageError] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [showAdminInput, setShowAdminInput] = useState(false); 
  const [adminPasswordInput, setAdminPasswordInput] = useState('');

  // Save Levels
  useEffect(() => {
    try {
      localStorage.setItem('spotTheDiffLevels', JSON.stringify(levels));
      setStorageError(null);
    } catch (e) {
      setStorageError("保存容量がいっぱいです。古いゲームを削除してください。");
    }
  }, [levels]);

  // Save News
  useEffect(() => {
    try {
      localStorage.setItem('spotTheDiffNews', JSON.stringify(news));
    } catch (e) {
      setStorageError("保存容量がいっぱいです。古いお知らせを削除してください。");
    }
  }, [news]);

  const deleteLevel = (id, e) => {
    e.stopPropagation();
    if (window.confirm('本当にこのレベルを削除しますか？')) {
      setLevels(levels.filter(l => l.id !== id));
    }
  };

  const handleAdminAuth = (e) => {
    e.preventDefault();
    if (adminPasswordInput === 'admin') {
      setIsAdmin(true);
      setShowAdminInput(false);
      setAdminPasswordInput('');
    } else {
      alert('パスワードが違います');
    }
  };

  const renderView = () => {
    switch (view) {
      case 'home':
        return (
          <div className="min-h-screen bg-[#F9FAFB] bg-grid-pattern text-slate-800">
            <FontsStyle />
            {/* Header - Hand-drawn style */}
            <header className="bg-white border-b-4 border-blue-400 py-4 sticky top-0 z-30 shadow-sm">
              <div className="max-w-6xl mx-auto px-4 md:px-6 flex items-center justify-between">
                <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('home')}>
                  <div className="bg-blue-500 text-white p-2 rounded-lg transform rotate-[-3deg] shadow-sm">
                    <Sparkles size={24} />
                  </div>
                  <h1 className="text-2xl md:text-3xl font-black tracking-tight text-blue-600 font-hand flex items-center gap-1">
                     脳トレ<br className="md:hidden"/>まちがいさがし
                  </h1>
                </div>
                
                <nav className="flex gap-6 text-base font-bold text-slate-500 font-hand items-center">
                  <span 
                    onClick={() => setView('news')}
                    className="cursor-pointer hover:text-blue-500 transition-colors border-b-2 border-transparent hover:border-blue-400 flex items-center gap-1"
                  >
                    <Bell size={18} /> おしらせ
                  </span>
                </nav>
              </div>
            </header>

            <main className="max-w-6xl mx-auto px-4 md:px-6 py-12 pb-32">
              
              {/* Hero Section - Pop & Colorful */}
              <div className="text-center mb-16 relative">
                <div className="absolute top-0 left-10 text-yellow-400 hidden md:block animate-bounce-slow">
                  <Star size={48} fill="currentColor" />
                </div>
                <div className="absolute bottom-0 right-10 text-pink-400 hidden md:block animate-pulse">
                  <Lightbulb size={48} />
                </div>

                <div className="inline-block bg-yellow-300 px-4 py-1 rounded-full transform rotate-[-2deg] mb-4 pop-shadow">
                  <p className="text-slate-800 font-black font-hand text-sm tracking-widest">★ BRAIN TRAINING ★</p>
                </div>
                
                <h2 className="text-3xl md:text-5xl font-black text-slate-800 mb-6 leading-snug font-hand">
                  <span className="bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-cyan-400">頭の体操</span>で今すぐ脳を活性化！<br/>
                  楽しく<span className="text-pink-500 inline-block transform hover:scale-110 transition-transform cursor-default">脳</span>を刺激しよう
                </h2>
                
                <div className="max-w-2xl mx-auto bg-white p-6 rounded-2xl border-2 border-slate-100 shadow-sm relative">
                  <div className="absolute -top-3 -left-3 bg-blue-500 text-white p-2 rounded-full transform rotate-[-10deg]">
                     <Pencil size={20} />
                  </div>
                  <p className="text-slate-600 font-bold font-hand text-lg">
                    2つの画像をよ～く見比べて、違うところを見つけてね。<br/>
                    全部見つけられるかな？ チャレンジしてみよう！
                  </p>
                </div>
                
                {isAdmin && (
                  <div className="mt-10">
                    <button 
                      onClick={() => setView('create')}
                      className="bg-pink-500 hover:bg-pink-600 text-white px-8 py-4 rounded-full font-black text-lg shadow-[4px_4px_0px_0px_#9d174d] hover:translate-y-1 hover:shadow-[2px_2px_0px_0px_#9d174d] transition-all flex items-center gap-3 mx-auto font-hand"
                    >
                      <Plus size={24} strokeWidth={3} />
                      新しい問題をつくる！
                    </button>
                  </div>
                )}
              </div>

              {storageError && (
                <div className="mb-8 bg-red-100 border-2 border-red-300 text-red-600 p-4 rounded-xl text-sm font-bold text-center font-hand">
                  <AlertCircle size={20} className="inline mr-2 mb-1" />
                  {storageError}
                </div>
              )}

              {/* Grid Layout */}
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-10">
                {levels.map((level, idx) => (
                  <div 
                    key={level.id} 
                    className="group cursor-pointer flex flex-col relative"
                    onClick={() => { setCurrentLevelId(level.id); setView('play'); }}
                  >
                    <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-6 bg-yellow-200/80 rotate-[-2deg] z-10 shadow-sm"></div>

                    <div className="bg-white p-3 pb-5 rounded-2xl border-2 border-slate-200 transition-all duration-200 hover:border-blue-400 hover:-translate-y-1 pop-shadow">
                      <div className="relative aspect-[4/3] bg-slate-100 rounded-xl overflow-hidden mb-4 border border-slate-100">
                        <img 
                          src={level.imgOriginal} 
                          alt={level.title} 
                          className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" 
                        />
                        <div className="absolute bottom-2 right-2 bg-white/90 backdrop-blur text-blue-600 text-xs font-black px-3 py-1 rounded-full border-2 border-blue-100">
                          {level.differences.length} ミス
                        </div>
                      </div>

                      <div className="px-1">
                        <div className="flex justify-between items-start">
                          <h3 className="font-bold text-lg text-slate-800 mb-1 leading-snug font-hand group-hover:text-blue-600 transition-colors line-clamp-1">
                            {level.title}
                          </h3>
                          <span className="bg-slate-100 text-slate-400 text-[10px] font-bold px-2 py-1 rounded-md ml-2 shrink-0">No.{idx + 1}</span>
                        </div>
                        
                        <div className="mt-3 flex items-center justify-between border-t-2 border-slate-100 pt-3 border-dashed">
                           <span className="text-xs font-bold text-slate-400 flex items-center gap-1">
                             <Play size={12} fill="currentColor" /> PLAY
                           </span>
                           
                           {isAdmin && (
                              <div className="flex gap-2" onClick={e => e.stopPropagation()}>
                                <button onClick={() => { setCurrentLevelId(level.id); setView('edit'); }} className="text-slate-400 hover:text-blue-500 bg-slate-50 p-1.5 rounded-md hover:bg-blue-50 transition-colors">
                                  <Edit3 size={16} />
                                </button>
                                <button onClick={(e) => deleteLevel(level.id, e)} className="text-slate-400 hover:text-red-500 bg-slate-50 p-1.5 rounded-md hover:bg-red-50 transition-colors">
                                  <Trash2 size={16} />
                                </button>
                              </div>
                           )}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              {levels.length === 0 && (
                <div className="text-center py-24 bg-white rounded-3xl border-4 border-slate-100 border-dashed">
                  <div className="text-slate-300 mb-4">
                    <ImageIcon size={64} className="mx-auto" />
                  </div>
                  <p className="text-slate-400 font-bold font-hand text-xl">まだ問題がありません</p>
                  <p className="text-slate-300 font-bold text-sm mt-2">管理者が追加するのを待ってね！</p>
                </div>
              )}

              {/* Footer / Admin */}
              <div className="mt-32 pt-12 border-t-4 border-slate-100 flex flex-col items-center gap-6">
                <div className="flex items-center gap-2 text-slate-300 font-black text-xl tracking-widest font-hand">
                  <Sparkles size={24} /> 脳トレまちがいさがし
                </div>
                
                {isAdmin ? (
                   <button 
                    onClick={() => setIsAdmin(false)}
                    className="text-xs font-bold text-white bg-red-400 hover:bg-red-500 px-4 py-2 rounded-full transition-colors flex items-center gap-1 shadow-sm"
                  >
                    <Unlock size={12} /> LOGOUT
                  </button>
                ) : (
                  !showAdminInput ? (
                    <button 
                      onClick={() => setShowAdminInput(true)}
                      className="text-xs font-bold text-slate-300 hover:text-slate-500 transition-colors flex items-center gap-1"
                    >
                      <Lock size={12} /> ADMIN
                    </button>
                  ) : (
                    <form onSubmit={handleAdminAuth} className="flex items-center gap-2 bg-white p-1.5 rounded-lg border-2 border-slate-200 shadow-sm animate-fade-in">
                      <input 
                        type="password" 
                        value={adminPasswordInput}
                        onChange={(e) => setAdminPasswordInput(e.target.value)}
                        placeholder="Pass"
                        className="px-2 py-1 text-sm outline-none w-24 font-bold text-slate-600 bg-transparent"
                        autoFocus
                      />
                      <button type="submit" className="bg-slate-800 text-white px-3 py-1.5 rounded-md text-xs font-bold hover:bg-slate-700">OK</button>
                    </form>
                  )
                )}
                <p className="text-[10px] font-bold text-slate-400">© 2025 脳トレまちがいさがし</p>
              </div>
            </main>
          </div>
        );

      case 'news':
        return (
          <NewsPage 
            news={news} 
            setNews={setNews} 
            isAdmin={isAdmin} 
            onBack={() => setView('home')} 
          />
        );

      case 'play':
        const playLevel = levels.find(l => l.id === currentLevelId);
        return <GamePlayer level={playLevel} onBack={() => setView('home')} />;

      case 'create':
        return <LevelEditor 
          onSave={(newLevel) => { 
            setLevels([newLevel, ...levels]); 
            setView('home'); 
          }} 
          onCancel={() => setView('home')} 
        />;

      case 'edit':
        const editLevel = levels.find(l => l.id === currentLevelId);
        return (
          <LevelEditor 
            initialData={editLevel} 
            onSave={(updatedLevel) => {
              setLevels(levels.map(l => l.id === updatedLevel.id ? updatedLevel : l));
              setView('home');
            }} 
            onCancel={() => setView('home')} 
          />
        );
      default:
        return null;
    }
  };

  return renderView();
};

// --- コンポーネント: おしらせページ ---
const NewsPage = ({ news, setNews, isAdmin, onBack }) => {
  const [isEditing, setIsEditing] = useState(false);
  const [newTitle, setNewTitle] = useState('');
  const [newContent, setNewContent] = useState('');
  const [newImage, setNewImage] = useState(''); // Holds Image or Video Data URL
  const [isLoading, setIsLoading] = useState(false);

  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    setIsLoading(true);
    try {
      if (file.type.startsWith('video/')) {
         // Video handling
         if (file.size > 2 * 1024 * 1024) { // 2MB limit to prevent storage crash
           alert("動画ファイルが大きすぎます。2MB以下のファイルをアップロードしてください。");
           setIsLoading(false);
           return;
         }
         const reader = new FileReader();
         reader.onload = (e) => {
           setNewImage(e.target.result);
           setIsLoading(false);
         };
         reader.onerror = () => {
            alert("動画の読み込みに失敗しました");
            setIsLoading(false);
         };
         reader.readAsDataURL(file);
      } else {
         // Image handling
         const resizedDataUrl = await resizeImage(file);
         setNewImage(resizedDataUrl);
         setIsLoading(false);
      }
    } catch (error) {
      alert("ファイルの処理に失敗しました");
      setIsLoading(false);
    }
    e.target.value = ''; 
  };

  const handlePost = () => {
    if (!newTitle || !newContent) {
      alert('タイトルと内容は必須です');
      return;
    }

    const now = new Date();
    const dateStr = `${now.getFullYear()}.${now.getMonth() + 1}.${now.getDate()}`;

    const newItem = {
      id: Date.now().toString(),
      date: dateStr,
      title: newTitle,
      content: newContent,
      image: newImage
    };

    setNews([newItem, ...news]);
    setIsEditing(false);
    setNewTitle('');
    setNewContent('');
    setNewImage('');
  };

  const handleDelete = (id) => {
    if(window.confirm('この記事を削除しますか？')) {
      setNews(news.filter(n => n.id !== id));
    }
  };

  return (
    <div className="min-h-screen bg-[#F9FAFB] bg-grid-pattern text-slate-800">
      <FontsStyle />
      {/* Header */}
      <header className="bg-white border-b-4 border-blue-400 py-4 sticky top-0 z-30 shadow-sm">
        <div className="max-w-4xl mx-auto px-4 flex items-center justify-between">
          <div className="flex items-center gap-2 text-blue-600 cursor-pointer" onClick={onBack}>
             <ArrowLeft size={24} />
             <h1 className="text-xl font-black font-hand">おしらせ一覧</h1>
          </div>
          <button onClick={onBack} className="text-slate-500 font-bold text-sm font-hand hover:text-blue-600">
            トップへ戻る
          </button>
        </div>
      </header>

      <main className="max-w-3xl mx-auto px-4 py-10">
        {isAdmin && !isEditing && (
          <div className="mb-8 text-center">
            <button 
              onClick={() => setIsEditing(true)}
              className="bg-pink-500 hover:bg-pink-600 text-white px-6 py-3 rounded-full font-black shadow-md flex items-center gap-2 mx-auto font-hand"
            >
              <Plus size={20} /> 新しいおしらせを書く
            </button>
          </div>
        )}

        {isEditing && (
          <div className="bg-white p-6 rounded-2xl border-2 border-blue-200 mb-10 shadow-lg animate-fade-in">
             <h2 className="font-black text-lg mb-4 flex items-center gap-2 text-blue-600"><Edit3 size={20}/> 記事の投稿</h2>
             
             <div className="space-y-4">
               <div>
                 <label className="block text-xs font-bold text-slate-400 mb-1">件名</label>
                 <input type="text" value={newTitle} onChange={e => setNewTitle(e.target.value)} className="w-full p-3 border-2 border-slate-200 rounded-lg font-bold focus:border-blue-400 outline-none" placeholder="タイトルを入力" />
               </div>
               <div>
                 <label className="block text-xs font-bold text-slate-400 mb-1">内容</label>
                 <textarea value={newContent} onChange={e => setNewContent(e.target.value)} className="w-full p-3 border-2 border-slate-200 rounded-lg font-medium focus:border-blue-400 outline-none h-32 resize-none" placeholder="記事の内容を入力" />
               </div>
               <div>
                 <label className="block text-xs font-bold text-slate-400 mb-1">画像・動画 (任意)</label>
                 <div className="flex items-start gap-4 flex-wrap">
                   <label className="cursor-pointer bg-slate-50 border-2 border-slate-200 hover:border-blue-400 px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-bold">
                     <Upload size={16} /> 画像・動画アップロード
                     <input type="file" accept="image/*,video/*" className="hidden" onChange={handleFileUpload} />
                   </label>
                   {isLoading && <span className="text-sm text-blue-500 font-bold">処理中...</span>}
                   {newImage && (
                     <div className="relative w-32 h-32 bg-slate-100 rounded-lg overflow-hidden border border-slate-200">
                       {newImage.startsWith('data:video') ? (
                         <video src={newImage} className="w-full h-full object-cover" controls />
                       ) : (
                         <img src={newImage} alt="Preview" className="w-full h-full object-cover" />
                       )}
                       <button onClick={() => setNewImage('')} className="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-bl-lg z-10"><X size={12}/></button>
                     </div>
                   )}
                 </div>
               </div>
               <div className="flex justify-end gap-3 pt-4 border-t border-slate-100 mt-4">
                 <button onClick={() => setIsEditing(false)} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-50 rounded-lg">キャンセル</button>
                 <button onClick={handlePost} className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-black shadow-md">投稿する</button>
               </div>
             </div>
          </div>
        )}

        <div className="space-y-8">
          {news.length === 0 ? (
            <div className="text-center py-20 text-slate-400 font-bold font-hand bg-white rounded-2xl border-2 border-dashed border-slate-200">
              まだおしらせはありません
            </div>
          ) : (
            news.map(item => (
              <article key={item.id} className="bg-white p-6 rounded-2xl border-2 border-slate-100 pop-shadow relative">
                {isAdmin && (
                  <button onClick={() => handleDelete(item.id)} className="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-colors z-10">
                    <Trash2 size={18} />
                  </button>
                )}
                <div className="flex items-center gap-2 text-slate-400 text-sm font-bold mb-2 font-hand">
                   <Calendar size={14} /> {item.date}
                </div>
                <h3 className="text-xl font-black text-slate-800 mb-4 pb-2 border-b border-slate-100">{item.title}</h3>
                <div className="text-slate-600 font-medium leading-relaxed whitespace-pre-wrap">
                  {item.content}
                </div>
                {item.image && (
                  <div className="mt-4 rounded-xl overflow-hidden border border-slate-100 inline-block max-w-full">
                    {item.image.startsWith('data:video') ? (
                      <video src={item.image} controls className="max-h-64 w-full bg-black" />
                    ) : (
                      <img src={item.image} alt="Attached" className="max-h-64 object-contain bg-slate-50" />
                    )}
                  </div>
                )}
              </article>
            ))
          )}
        </div>
      </main>
    </div>
  );
};

// --- ゲームプレイヤー ---
const GamePlayer = ({ level, onBack }) => {
  const [foundIds, setFoundIds] = useState([]);
  const [mistakes, setMistakes] = useState([]);
  const [isCompleted, setIsCompleted] = useState(false);
  const imgRef = useRef(null);

  useEffect(() => {
    if (isCompleted) {
      playSound('clear');
    }
  }, [isCompleted]);

  const handleImageClick = (e) => {
    if (isCompleted) return;

    const rect = imgRef.current.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;

    const hit = level.differences.find(diff => {
      if (foundIds.includes(diff.id)) return false;
      const dist = Math.sqrt(Math.pow(diff.x - x, 2) + Math.pow(diff.y - y, 2));
      return dist < (diff.radius || 5);
    });

    if (hit) {
      playSound('correct');
      const newFound = [...foundIds, hit.id];
      setFoundIds(newFound);
      if (newFound.length === level.differences.length) {
        setIsCompleted(true);
      }
    } else {
      playSound('wrong');
      const mistakeId = Date.now();
      setMistakes(prev => [...prev, { id: mistakeId, x, y }]);
      setTimeout(() => {
        setMistakes(prev => prev.filter(m => m.id !== mistakeId));
      }, 800);
    }
  };

  return (
    <div className="flex flex-col min-h-screen bg-[#F9FAFB] bg-grid-pattern text-slate-800">
      <FontsStyle />
      
      {/* Header */}
      <header className="h-16 bg-white flex items-center justify-between px-4 md:px-8 border-b-4 border-blue-400 sticky top-0 z-30 shadow-sm">
        <button 
          onClick={onBack} 
          className="text-slate-500 hover:text-blue-600 flex items-center gap-2 transition-colors font-bold text-sm font-hand bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-blue-50 hover:border-blue-200"
        >
          <ArrowLeft size={20} /> もどる
        </button>
        
        <div className="flex items-center gap-4">
           <div className="bg-yellow-100 px-4 py-1 rounded-full border-2 border-yellow-300 flex items-baseline gap-2">
              <span className="text-xs font-black text-yellow-600 uppercase font-hand">FOUND</span>
              <div className="flex items-baseline font-black text-slate-800">
                <span className="text-xl text-blue-600">{foundIds.length}</span>
                <span className="text-sm text-slate-400 mx-1">/</span>
                <span className="text-lg">{level.differences.length}</span>
              </div>
           </div>
        </div>
      </header>

      {/* Scrollable Content Area */}
      <div className="flex-1 overflow-y-auto pb-20">
        <div className="max-w-6xl mx-auto px-4 pt-8 md:pt-12">
          
          {/* Title Section */}
          <div className="text-center mb-8">
            <h1 className="text-2xl md:text-4xl font-black text-slate-800 mb-2 font-hand tracking-tight relative inline-block">
              {level.title}
              <div className="absolute -bottom-1 left-0 w-full h-3 bg-yellow-200/60 -z-10 transform rotate-[-1deg]"></div>
            </h1>
            <p className="text-slate-500 font-bold text-sm mt-2 font-hand">2つの画像を見比べて、違うところをタップしよう！</p>
          </div>

          <div className="flex flex-col md:flex-row gap-8 items-center justify-center">
            
            {/* Image 1: Original */}
            <div className="w-full max-w-lg bg-white p-3 rounded-2xl border-2 border-slate-200 pop-shadow">
              <div className="mb-2 flex items-center gap-2">
                 <div className="bg-blue-500 text-white text-xs font-black px-3 py-1 rounded-full transform rotate-[-2deg]">見本 (Original)</div>
                 <div className="h-2 bg-slate-100 flex-1 rounded-full border border-slate-200"></div>
              </div>
              <div className="relative aspect-square bg-slate-50 rounded-xl overflow-hidden border border-slate-100">
                <img src={level.imgOriginal} alt="Original" className="w-full h-full object-contain pointer-events-none select-none" />
                {level.differences.map(diff => (
                  foundIds.includes(diff.id) && (
                    <div
                      key={diff.id}
                      className="absolute border-[4px] border-blue-400 rounded-full animate-ping-once"
                      style={{
                        left: `${diff.x}%`,
                        top: `${diff.y}%`,
                        width: `${(diff.radius || 5) * 2}%`,
                        height: `${(diff.radius || 5) * 2}%`,
                        transform: 'translate(-50%, -50%)',
                        aspectRatio: '1/1'
                      }}
                    />
                  )
                ))}
              </div>
            </div>

            {/* Image 2: Difference (Play Area) */}
            <div className="w-full max-w-lg bg-white p-3 rounded-2xl border-4 border-pink-300 shadow-xl relative">
              <div className="absolute -right-3 -top-3 bg-yellow-400 text-slate-900 font-black px-3 py-1 rounded-lg shadow-sm transform rotate-[5deg] z-10 text-xs animate-bounce-slow">
                ここをタップ！
              </div>
              <div className="mb-2 flex items-center gap-2">
                 <div className="bg-pink-500 text-white text-xs font-black px-3 py-1 rounded-full transform rotate-[-2deg]">間違い (Mistake)</div>
                 <div className="h-2 bg-slate-100 flex-1 rounded-full border border-slate-200"></div>
              </div>
              <div 
                className="relative aspect-square bg-slate-50 rounded-xl overflow-hidden border-2 border-slate-100 cursor-crosshair"
                onClick={handleImageClick}
              >
                <img 
                  ref={imgRef}
                  src={level.imgDiff} 
                  alt="Difference" 
                  className="w-full h-full object-contain select-none" 
                />

                {level.differences.map(diff => (
                  foundIds.includes(diff.id) && (
                    <div
                      key={diff.id}
                      className="absolute border-[4px] border-pink-500 rounded-full bg-pink-500/10"
                      style={{
                        left: `${diff.x}%`,
                        top: `${diff.y}%`,
                        width: `${(diff.radius || 5) * 2}%`,
                        height: `${(diff.radius || 5) * 2}%`,
                        transform: 'translate(-50%, -50%)',
                        aspectRatio: '1/1'
                      }}
                    >
                       {/* Checkmark decoration */}
                       <div className="absolute -top-3 -right-3 bg-pink-500 text-white rounded-full p-1.5 shadow-sm scale-90 border-2 border-white">
                          <CheckCircle size={16} strokeWidth={3} />
                       </div>
                    </div>
                  )
                ))}

                {mistakes.map(m => (
                  <div
                    key={m.id}
                    className="absolute text-slate-400 pointer-events-none animate-bounce-short"
                    style={{
                      left: `${m.x}%`,
                      top: `${m.y}%`,
                      transform: 'translate(-50%, -50%)'
                    }}
                  >
                    <X size={60} strokeWidth={5} className="drop-shadow-lg text-red-500" />
                  </div>
                ))}
              </div>
            </div>

          </div>
        </div>
      </div>

      {/* Completion Modal */}
      {isCompleted && (
        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4">
          <div className="bg-white p-8 rounded-3xl max-w-sm w-full text-center transform animate-scale-in shadow-[8px_8px_0px_0px_rgba(0,0,0,0.2)] border-4 border-slate-800 relative overflow-hidden">
            <div className="bg-grid-pattern absolute inset-0 opacity-10"></div>
            
            <div className="w-24 h-24 bg-yellow-300 text-slate-900 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-slate-800 relative z-10">
              <Trophy size={48} fill="white" strokeWidth={2} />
            </div>
            
            <h3 className="text-3xl font-black text-slate-800 mb-2 font-hand tracking-widest">CLEAR!!</h3>
            <p className="text-slate-600 mb-8 font-bold text-sm">おめでとう！<br/>すごい観察力だね！</p>
            
            <div className="flex flex-col gap-3 relative z-10">
               <button 
                onClick={() => {
                  setFoundIds([]);
                  setIsCompleted(false);
                }}
                className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-black transition-all flex items-center justify-center gap-2 shadow-[0_4px_0_#1e40af] active:shadow-none active:translate-y-1 border-2 border-blue-700"
              >
                <RotateCcw size={20} strokeWidth={3} />
                もう一度あそぶ
              </button>
              <button 
                onClick={onBack}
                className="w-full bg-white hover:bg-slate-50 text-slate-600 py-3 rounded-xl font-black transition-all border-2 border-slate-300 shadow-[0_4px_0_#cbd5e1] active:shadow-none active:translate-y-1"
              >
                一覧にもどる
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// --- レベルエディタ (管理者のみ) ---
const LevelEditor = ({ initialData, onSave, onCancel }) => {
  const [title, setTitle] = useState(initialData?.title || '');
  const [imgOriginal, setImgOriginal] = useState(initialData?.imgOriginal || '');
  const [imgDiff, setImgDiff] = useState(initialData?.imgDiff || '');
  const [differences, setDifferences] = useState(initialData?.differences || []);
  const [activeTab, setActiveTab] = useState('setup');
  const [isLoading, setIsLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState('');
  const editImgRef = useRef(null);

  const handleFileUpload = async (e, setUrl) => {
    const file = e.target.files[0];
    if (!file) return;
    setErrorMsg('');
    setIsLoading(true);
    try {
      const resizedDataUrl = await resizeImage(file);
      setUrl(resizedDataUrl);
    } catch (error) {
      setErrorMsg("エラー: 画像の処理に失敗しました");
    } finally {
      setIsLoading(false);
    }
    e.target.value = ''; 
  };

  const handleAddDifference = (e) => {
    if (!editImgRef.current) return;
    const rect = editImgRef.current.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;
    setDifferences([...differences, { id: Date.now().toString(), x, y, radius: 5 }]);
    playSound('click');
  };

  const handleRemoveDifference = (id, e) => {
    e.stopPropagation();
    setDifferences(differences.filter(d => d.id !== id));
  };

  const handleSave = () => {
    if (!title.trim() || !imgOriginal || !imgDiff) {
      setErrorMsg('必須項目を入力してください');
      return;
    }
    onSave({
      id: initialData?.id || Date.now().toString(),
      title,
      imgOriginal,
      imgDiff,
      differences
    });
  };

  return (
    <div className="min-h-screen bg-grid-pattern bg-slate-50 text-slate-800 pb-20">
      <FontsStyle />
      {/* Editor Header */}
      <div className="bg-white border-b-2 border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-30 shadow-sm">
        <h2 className="text-lg font-black text-slate-800 flex items-center gap-2 font-hand">
          <Edit3 size={24} className="text-blue-500" />
          {initialData ? 'もんだいを編集' : '新しいもんだい'}
        </h2>
        <div className="flex items-center gap-4">
          {errorMsg && <span className="text-red-600 text-sm font-bold bg-red-50 px-2 py-1 rounded border border-red-100">{errorMsg}</span>}
          <button onClick={onCancel} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-bold text-sm transition-colors">キャンセル</button>
          <button onClick={handleSave} disabled={isLoading} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-[0_4px_0_#1e40af] active:shadow-none active:translate-y-1 disabled:opacity-50 transition-all">
            {isLoading ? '処理中...' : '保存して公開'}
          </button>
        </div>
      </div>

      <div className="max-w-4xl mx-auto p-6">
        <div className="bg-white rounded-2xl shadow-sm border-2 border-slate-200 overflow-hidden">
          <div className="flex border-b-2 border-slate-200">
            <button onClick={() => setActiveTab('setup')} className={`flex-1 py-4 text-sm font-black ${activeTab === 'setup' ? 'text-blue-600 bg-blue-50/50 border-b-4 border-blue-500' : 'text-slate-400 hover:bg-slate-50'}`}>
              1. 画像とタイトル
            </button>
            <button onClick={() => setActiveTab('place')} className={`flex-1 py-4 text-sm font-black ${activeTab === 'place' ? 'text-blue-600 bg-blue-50/50 border-b-4 border-blue-500' : 'text-slate-400 hover:bg-slate-50'}`}>
              2. 間違い設定 ({differences.length})
            </button>
          </div>

          <div className="p-8">
            {isLoading && (
              <div className="absolute inset-0 bg-white/80 z-50 flex items-center justify-center">
                <div className="animate-spin rounded-full h-10 w-10 border-4 border-slate-200 border-t-blue-500"></div>
              </div>
            )}

            {activeTab === 'setup' ? (
              <div className="space-y-8 max-w-xl mx-auto">
                <div>
                  <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Title</label>
                  <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="例：実験室の間違いさがし" className="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:outline-none focus:ring-0 focus:border-blue-400 font-bold text-lg transition-colors" />
                </div>
                
                {[
                  { label: '正解画像 (Original)', val: imgOriginal, set: setImgOriginal, color: 'text-blue-500' },
                  { label: '間違い画像 (Difference)', val: imgDiff, set: setImgDiff, color: 'text-pink-500' }
                ].map((field, i) => (
                  <div key={i} className="p-6 rounded-2xl border-2 border-slate-200 bg-white">
                    <label className={`flex items-center gap-2 text-sm font-black ${field.color} mb-4`}>
                      <ImageIcon size={20}/> {field.label}
                    </label>
                    <div className="flex gap-3 mb-4">
                      <label className="cursor-pointer bg-slate-50 border-2 border-slate-200 hover:border-blue-400 hover:bg-blue-50 px-4 py-3 rounded-xl flex items-center gap-2 text-sm font-bold transition-all w-full justify-center group">
                        <Upload size={18} className="group-hover:scale-110 transition-transform"/> 画像を選択 / アップロード
                        <input type="file" accept="image/*" className="hidden" onChange={(e) => handleFileUpload(e, field.set)} />
                      </label>
                    </div>
                    <div className="aspect-square bg-slate-100 rounded-xl border-2 border-slate-200 border-dashed flex items-center justify-center overflow-hidden relative">
                      {field.val ? <img src={field.val} className="w-full h-full object-contain" alt="Preview" /> : <span className="text-slate-400 text-xs font-bold">NO IMAGE</span>}
                    </div>
                  </div>
                ))}
                
                <button onClick={() => setActiveTab('place')} disabled={!imgDiff || !imgOriginal} className="w-full bg-blue-500 hover:bg-blue-600 disabled:opacity-50 text-white py-4 rounded-xl font-black shadow-[0_4px_0_#1e40af] active:shadow-none active:translate-y-1 transition-all text-lg">
                  次へすすむ
                </button>
              </div>
            ) : (
              <div className="flex flex-col items-center">
                <div className="text-blue-600 text-sm font-black mb-6 flex items-center gap-2 bg-blue-50 px-4 py-2 rounded-full border border-blue-100">
                  <MousePointer2 size={16} /> 画像をタップして間違い箇所を追加
                </div>
                <div className="relative w-full max-w-lg aspect-square bg-slate-100 rounded-xl overflow-hidden cursor-crosshair border-4 border-slate-200 shadow-sm" onClick={handleAddDifference}>
                  {imgDiff ? <img ref={editImgRef} src={imgDiff} alt="Work area" className="w-full h-full object-contain select-none" /> : <div className="flex items-center justify-center h-full text-slate-400">画像なし</div>}
                  {differences.map((diff, index) => (
                    <div key={diff.id} className="absolute border-2 border-pink-500 bg-pink-500/30 rounded-full flex items-center justify-center group hover:scale-110 transition-transform" style={{ left: `${diff.x}%`, top: `${diff.y}%`, width: `${diff.radius * 2}%`, height: `${diff.radius * 2}%`, transform: 'translate(-50%, -50%)', aspectRatio: '1/1' }}>
                      <span className="text-xs font-bold text-white drop-shadow-md pointer-events-none">{index + 1}</span>
                      <button onClick={(e) => handleRemoveDifference(diff.id, e)} className="absolute -top-2 -right-2 bg-slate-800 text-white rounded-full p-1.5 shadow-md opacity-0 group-hover:opacity-100 transition-opacity"><X size={10} /></button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
